name: test

on:
  push:
    branches:
      - '**'
    tags-ignore:
      - '**'
  workflow_dispatch:  # Allow manual triggering

env:
  LOCALSTACK_IMAGE: localstack/localstack:3.4.0
  MYSQL_IMAGE: mysql:8.0.31
  NGINX_IMAGE: nginx:1.23.2
  STATSD_IMAGE: dblworks/statsd:v0.10.2
  KAFKA_IMAGE: apache/kafka:4.0.0
  NSQ_IMAGE: nsqio/nsq:v1.2.1

jobs:
  unit-tests:
    if: ${{ github.event.repository.private == true }}
    runs-on: ubuntu-latest

    services:
      postgres:
        image: postgres
        ports:
          - 5432:5432
        env:
          POSTGRES_USER: enricher
          POSTGRES_PASSWORD: supersecret1
          POSTGRES_DB: sql_enrichment_test
          POSTGRES_PORT: 5432
        options: --health-cmd pg_isready --health-interval 10s --health-timeout 5s --health-retries 5

    steps:
    - uses: actions/checkout@v4
    - uses: coursier/cache-action@v6
    - name: Set up JDK 21
      uses: actions/setup-java@v4
      with:
        java-version: 21
        distribution: 'temurin'
    - name: Install sbt
      uses: sbt/setup-sbt@v1
    - name: Start HTTP server to test API enrichment in Common Enrich
      run: python integration-tests/common/api-enrichment-test.py 8001 &
    - name: Prepare data in Postgres to test SQL enrichment in Common Enrich
      run: psql -h localhost -p 5432 -U enricher -d sql_enrichment_test < integration-tests/common/sql-enrichment-test.sql
      env:
        PGPASSWORD: supersecret1
    - name: Check Scala formatting
      run: sbt scalafmtCheckAll
    - name: Unit tests common
      run: SBT_OPTS="-Xms1G -Xmx8G -Xss4M -XX:MaxMetaspaceSize=1024M" sbt "project common; +test"
      env:
        OER_KEY: ${{ secrets.OER_KEY }}
    - name: Unit tests core
      run: SBT_OPTS="-Xms1G -Xmx8G -Xss4M -XX:MaxMetaspaceSize=1024M" sbt "project core; +test"
    - name: Unit tests Kinesis
      run: SBT_OPTS="-Xms1G -Xmx8G -Xss4M -XX:MaxMetaspaceSize=1024M" sbt "project kinesis; +test"
    - name: Unit tests Pubsub
      run: SBT_OPTS="-Xms1G -Xmx8G -Xss4M -XX:MaxMetaspaceSize=1024M" sbt "project pubsub; +test"
    - name: Unit tests Kafka
      run: SBT_OPTS="-Xms1G -Xmx8G -Xss4M -XX:MaxMetaspaceSize=1024M" sbt "project kafka; +test"
    - name: Unit tests Nsq
      run: SBT_OPTS="-Xms1G -Xmx8G -Xss4M -XX:MaxMetaspaceSize=1024M" sbt "project nsq; +test"

  it-kinesis:
    if: ${{ github.event.repository.private == true }}
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
      - uses: coursier/cache-action@v6

      - name: Cache localstack image
        uses: actions/cache@v4
        with:
          path: /tmp/docker-images/localstack.tar
          key: docker-${{ env.LOCALSTACK_IMAGE }}

      - name: Cache mysql image
        uses: actions/cache@v4
        with:
          path: /tmp/docker-images/mysql.tar
          key: docker-${{ env.MYSQL_IMAGE }}

      - name: Cache nginx image
        uses: actions/cache@v4
        with:
          path: /tmp/docker-images/nginx.tar
          key: docker-${{ env.NGINX_IMAGE }}

      - name: Cache statsd image
        uses: actions/cache@v4
        with:
          path: /tmp/docker-images/statsd.tar
          key: docker-${{ env.STATSD_IMAGE }}

      - name: Load or pull Docker images
        run: |
          mkdir -p /tmp/docker-images

          # Load from cache if available, otherwise pull and save
          if [ -f /tmp/docker-images/localstack.tar ]; then
            echo "Loading cached localstack image..."
            docker load -i /tmp/docker-images/localstack.tar
          else
            echo "Pulling localstack image..."
            docker pull $LOCALSTACK_IMAGE
            docker save $LOCALSTACK_IMAGE -o /tmp/docker-images/localstack.tar
          fi

          if [ -f /tmp/docker-images/mysql.tar ]; then
            echo "Loading cached mysql image..."
            docker load -i /tmp/docker-images/mysql.tar
          else
            echo "Pulling mysql image..."
            docker pull $MYSQL_IMAGE
            docker save $MYSQL_IMAGE -o /tmp/docker-images/mysql.tar
          fi

          if [ -f /tmp/docker-images/nginx.tar ]; then
            echo "Loading cached nginx image..."
            docker load -i /tmp/docker-images/nginx.tar
          else
            echo "Pulling nginx image..."
            docker pull $NGINX_IMAGE
            docker save $NGINX_IMAGE -o /tmp/docker-images/nginx.tar
          fi

          if [ -f /tmp/docker-images/statsd.tar ]; then
            echo "Loading cached statsd image..."
            docker load -i /tmp/docker-images/statsd.tar
          else
            echo "Pulling statsd image..."
            docker pull $STATSD_IMAGE
            docker save $STATSD_IMAGE -o /tmp/docker-images/statsd.tar
          fi

      - name: Set up JDK 21
        uses: actions/setup-java@v4
        with:
          java-version: 21
          distribution: 'temurin'
      - name: Install sbt
        uses: sbt/setup-sbt@v1
      - name: Run integration tests for enrich-kinesis
        run: sbt "project itKinesis; testOnly *EnrichKinesisSpec"
        env:
          AWS_ACCESS_KEY_ID: foo
          AWS_SECRET_ACCESS_KEY: bar
          AWS_REGION: eu-central-1

  it-drop-events:
    if: ${{ github.event.repository.private == true }}
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
      - uses: coursier/cache-action@v6

      - name: Cache localstack image
        uses: actions/cache@v4
        with:
          path: /tmp/docker-images/localstack.tar
          key: docker-${{ env.LOCALSTACK_IMAGE }}

      - name: Cache statsd image
        uses: actions/cache@v4
        with:
          path: /tmp/docker-images/statsd.tar
          key: docker-${{ env.STATSD_IMAGE }}

      - name: Load or pull Docker images
        run: |
          mkdir -p /tmp/docker-images

          if [ -f /tmp/docker-images/localstack.tar ]; then
            echo "Loading cached localstack image..."
            docker load -i /tmp/docker-images/localstack.tar
          else
            echo "Pulling localstack image..."
            docker pull $LOCALSTACK_IMAGE
            docker save $LOCALSTACK_IMAGE -o /tmp/docker-images/localstack.tar
          fi

          if [ -f /tmp/docker-images/statsd.tar ]; then
            echo "Loading cached statsd image..."
            docker load -i /tmp/docker-images/statsd.tar
          else
            echo "Pulling statsd image..."
            docker pull $STATSD_IMAGE
            docker save $STATSD_IMAGE -o /tmp/docker-images/statsd.tar
          fi

      - name: Set up JDK 21
        uses: actions/setup-java@v4
        with:
          java-version: 21
          distribution: 'temurin'
      - name: Install sbt
        uses: sbt/setup-sbt@v1
      - name: Run integration tests for 'drop events' feature
        run: sbt "project itKinesis; testOnly *DropEventsSpec"
        env:
          AWS_ACCESS_KEY_ID: foo
          AWS_SECRET_ACCESS_KEY: bar
          AWS_REGION: eu-central-1

  it-kafka:
    if: ${{ github.event.repository.private == true }}
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
      - uses: coursier/cache-action@v6

      - name: Cache kafka image
        uses: actions/cache@v4
        with:
          path: /tmp/docker-images/kafka.tar
          key: docker-${{ env.KAFKA_IMAGE }}

      - name: Load or pull Docker images
        run: |
          mkdir -p /tmp/docker-images

          if [ -f /tmp/docker-images/kafka.tar ]; then
            echo "Loading cached kafka image..."
            docker load -i /tmp/docker-images/kafka.tar
          else
            echo "Pulling kafka image..."
            docker pull $KAFKA_IMAGE
            docker save $KAFKA_IMAGE -o /tmp/docker-images/kafka.tar
          fi

      - name: Set up JDK 21
        uses: actions/setup-java@v4
        with:
          java-version: 21
          distribution: 'temurin'
      - name: Install sbt
        uses: sbt/setup-sbt@v1
      - name: Run integration tests for enrich-kafka
        run: sbt "project itKafka; test"

  it-nsq:
    if: ${{ github.event.repository.private == true }}
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
      - uses: coursier/cache-action@v6

      - name: Cache nsq image
        uses: actions/cache@v4
        with:
          path: /tmp/docker-images/nsq.tar
          key: docker-${{ env.NSQ_IMAGE }}

      - name: Load or pull Docker images
        run: |
          mkdir -p /tmp/docker-images

          if [ -f /tmp/docker-images/nsq.tar ]; then
            echo "Loading cached nsq image..."
            docker load -i /tmp/docker-images/nsq.tar
          else
            echo "Pulling nsq image..."
            docker pull $NSQ_IMAGE
            docker save $NSQ_IMAGE -o /tmp/docker-images/nsq.tar
          fi

      - name: Set up JDK 21
        uses: actions/setup-java@v4
        with:
          java-version: 21
          distribution: 'temurin'
      - name: Install sbt
        uses: sbt/setup-sbt@v1
      - name: Run integration tests for enrich-nsq
        run: sbt "project itNsq; test"
