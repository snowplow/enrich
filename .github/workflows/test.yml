name: test

on:
  push:
    branches:
      - '**'
    tags-ignore:
      - '**'

jobs:
  unit-tests:
    if: ${{ github.event.repository.private == true }}
    runs-on: ubuntu-latest

    services:
      postgres:
        image: postgres
        ports:
          - 5432:5432
        env:
          POSTGRES_USER: enricher
          POSTGRES_PASSWORD: supersecret1
          POSTGRES_DB: sql_enrichment_test
          POSTGRES_PORT: 5432
        options: --health-cmd pg_isready --health-interval 10s --health-timeout 5s --health-retries 5

    steps:
    - uses: actions/checkout@v4
    - uses: coursier/cache-action@v6
    - name: Set up JDK 21
      uses: actions/setup-java@v4
      with:
        java-version: 21
        distribution: 'temurin'
    - name: Install sbt
      uses: sbt/setup-sbt@v1
    - name: Start HTTP server to test API enrichment in Common Enrich
      run: python integration-tests/common/api-enrichment-test.py 8001 &
    - name: Prepare data in Postgres to test SQL enrichment in Common Enrich
      run: psql -h localhost -p 5432 -U enricher -d sql_enrichment_test < integration-tests/common/sql-enrichment-test.sql
      env:
        PGPASSWORD: supersecret1
    - name: Check Scala formatting
      run: sbt scalafmtCheckAll
    - name: Unit tests common
      run: SBT_OPTS="-Xms1G -Xmx8G -Xss4M -XX:MaxMetaspaceSize=1024M" sbt "project common; +test"
      env:
        OER_KEY: ${{ secrets.OER_KEY }}
    - name: Unit tests core
      run: SBT_OPTS="-Xms1G -Xmx8G -Xss4M -XX:MaxMetaspaceSize=1024M" sbt "project core; +test"
    - name: Unit tests Kinesis
      run: SBT_OPTS="-Xms1G -Xmx8G -Xss4M -XX:MaxMetaspaceSize=1024M" sbt "project kinesis; +test"
    - name: Unit tests Pubsub
      run: SBT_OPTS="-Xms1G -Xmx8G -Xss4M -XX:MaxMetaspaceSize=1024M" sbt "project pubsub; +test"
    - name: Unit tests Kafka
      run: SBT_OPTS="-Xms1G -Xmx8G -Xss4M -XX:MaxMetaspaceSize=1024M" sbt "project kafka; +test"
    - name: Unit tests Nsq
      run: SBT_OPTS="-Xms1G -Xmx8G -Xss4M -XX:MaxMetaspaceSize=1024M" sbt "project nsq; +test"

  it-kinesis:
    if: ${{ github.event.repository.private == true }}
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
      - uses: coursier/cache-action@v6
      - name: Set up JDK 21
        uses: actions/setup-java@v4
        with:
          java-version: 21
          distribution: 'temurin'
      - name: Install sbt
        uses: sbt/setup-sbt@v1
      - name: Run integration tests for enrich-kinesis
        run: sbt "project itKinesis; testOnly *EnrichKinesisSpec"
        env:
          AWS_ACCESS_KEY_ID: foo
          AWS_SECRET_ACCESS_KEY: bar
          AWS_REGION: eu-central-1

  it-drop-events:
    if: ${{ github.event.repository.private == true }}
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
      - uses: coursier/cache-action@v6
      - name: Set up JDK 21
        uses: actions/setup-java@v4
        with:
          java-version: 21
          distribution: 'temurin'
      - name: Install sbt
        uses: sbt/setup-sbt@v1
      - name: Run integration tests for 'drop events' feature
        run: sbt "project itKinesis; testOnly *DropEventsSpec"
        env:
          AWS_ACCESS_KEY_ID: foo
          AWS_SECRET_ACCESS_KEY: bar
          AWS_REGION: eu-central-1

  it-kafka:
    if: ${{ github.event.repository.private == true }}
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
      - uses: coursier/cache-action@v6
      - name: Set up JDK 21
        uses: actions/setup-java@v4
        with:
          java-version: 21
          distribution: 'temurin'
      - name: Install sbt
        uses: sbt/setup-sbt@v1
      - name: Run integration tests for enrich-kafka
        run: sbt "project itKafka; test"

  it-nsq:
    if: ${{ github.event.repository.private == true }}
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
      - uses: coursier/cache-action@v6
      - name: Set up JDK 21
        uses: actions/setup-java@v4
        with:
          java-version: 21
          distribution: 'temurin'
      - name: Install sbt
        uses: sbt/setup-sbt@v1
      - name: Run integration tests for enrich-nsq
        run: sbt "project itNsq; test"
