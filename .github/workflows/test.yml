name: test

on:
  push:
    branches:
      - '**'
    tags-ignore:
      - '**'

jobs:
  unit-tests:
    if: ${{ github.event.repository.private == true }}
    runs-on: ubuntu-latest

    services:
      postgres:
        image: postgres
        ports:
          - 5432:5432
        env:
          POSTGRES_USER: enricher
          POSTGRES_PASSWORD: supersecret1
          POSTGRES_DB: sql_enrichment_test
          POSTGRES_PORT: 5432
        options: --health-cmd pg_isready --health-interval 10s --health-timeout 5s --health-retries 5

    steps:
    - uses: actions/checkout@v4
    - uses: coursier/cache-action@v6
    - name: Set up JDK 21
      uses: actions/setup-java@v4
      with:
        java-version: 21
        distribution: 'temurin'
    - name: Install sbt
      uses: sbt/setup-sbt@v1
    - name: Start HTTP server to test API enrichment in Common Enrich
      run: python integration-tests/common/api-enrichment-test.py 8001 &
    - name: Start HTTP server to test API enrichment in Common Fs2
      run: python integration-tests/common-fs2/api-enrichment-test.py 8000 &
    - name: Prepare data in Postgres to test SQL enrichment in Common Enrich
      run: psql -h localhost -p 5432 -U enricher -d sql_enrichment_test < integration-tests/common/sql-enrichment-test.sql
      env:
        PGPASSWORD: supersecret1
    - name: Prepare data in Postgres to test SQL enrichment in Common Fs2
      run: psql -h localhost -p 5432 -U enricher -d sql_enrichment_test < integration-tests/common-fs2/sql-enrichment-test.sql
      env:
        PGPASSWORD: supersecret1
    - name: Check Scala formatting
      run: sbt scalafmtCheckAll
    - name: Run tests
      run: SBT_OPTS="-Xms1G -Xmx8G -Xss4M -XX:MaxMetaspaceSize=1024M" TESTCONTAINERS_RYUK_DISABLED=true sbt +test
      env:
        OER_KEY: ${{ secrets.OER_KEY }}

  it-kinesis:
    if: ${{ github.event.repository.private == true }}
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
      - uses: coursier/cache-action@v6
      - name: Set up JDK 21
        uses: actions/setup-java@v4
        with:
          java-version: 21
          distribution: 'temurin'
      - name: Install sbt
        uses: sbt/setup-sbt@v1
      - name: Publish asset
        run: sbt "project kinesisDistroless; publishLocal"
      - name: Run integration tests for enrich-kinesis
        run: sbt "project kinesisDistroless;it:testOnly *EnrichKinesisSpec"
        env:
          AWS_ACCESS_KEY_ID: foo
          AWS_SECRET_ACCESS_KEY: bar

  it-kinesis-streams:
    if: ${{ github.event.repository.private == true }}
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
      - uses: coursier/cache-action@v6
      - name: Set up JDK 21
        uses: actions/setup-java@v4
        with:
          java-version: 21
          distribution: 'temurin'
      - name: Install sbt
        uses: sbt/setup-sbt@v1
      - name: Publish asset
        run: sbt "project kinesisStreamsDistroless; publishLocal"
      - name: Run integration tests for enrich-kinesis
        run: sbt "project kinesisStreamsDistroless;it:testOnly *EnrichKinesisSpec"
        env:
          AWS_ACCESS_KEY_ID: foo
          AWS_SECRET_ACCESS_KEY: bar
          AWS_REGION: eu-central-1

  it-drop-events:
    if: ${{ github.event.repository.private == true }}
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
      - uses: coursier/cache-action@v6
      - name: Set up JDK 21
        uses: actions/setup-java@v4
        with:
          java-version: 21
          distribution: 'temurin'
      - name: Install sbt
        uses: sbt/setup-sbt@v1
      - name: Publish asset
        run: sbt "project kinesisDistroless; publishLocal"
      - name: Run integration tests for 'drop events' feature
        run: sbt "project kinesisDistroless;it:testOnly *DropEventsSpec"
        env:
          AWS_ACCESS_KEY_ID: foo
          AWS_SECRET_ACCESS_KEY: bar

  it-drop-events-streams:
    if: ${{ github.event.repository.private == true }}
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
      - uses: coursier/cache-action@v6
      - name: Set up JDK 21
        uses: actions/setup-java@v4
        with:
          java-version: 21
          distribution: 'temurin'
      - name: Install sbt
        uses: sbt/setup-sbt@v1
      - name: Publish asset
        run: sbt "project kinesisStreamsDistroless; publishLocal"
      - name: Run integration tests for 'drop events' feature
        run: sbt "project kinesisStreamsDistroless;it:testOnly *DropEventsSpec"
        env:
          AWS_ACCESS_KEY_ID: foo
          AWS_SECRET_ACCESS_KEY: bar
          AWS_REGION: eu-central-1

  it-kafka:
    if: ${{ github.event.repository.private == true }}
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
      - uses: coursier/cache-action@v6
      - name: Set up JDK 21
        uses: actions/setup-java@v4
        with:
          java-version: 21
          distribution: 'temurin'
      - name: Install sbt
        uses: sbt/setup-sbt@v1
      - name: Publish asset
        run: sbt "project kafka; publishLocal"
      - name: Run integration tests for enrich-kafka
        run: |
          docker compose -f integration-tests/enrich-kafka/docker-compose.yml up -d
          sbt "project kafka" IntegrationTest/test
          docker compose -f integration-tests/enrich-kafka/docker-compose.yml down

  it-kafka-streams:
    if: ${{ github.event.repository.private == true }}
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
      - uses: coursier/cache-action@v6
      - name: Set up JDK 21
        uses: actions/setup-java@v4
        with:
          java-version: 21
          distribution: 'temurin'
      - name: Install sbt
        uses: sbt/setup-sbt@v1
      - name: Run integration tests for enrich-kafka
        run: sbt "project kafkaStreamsDistroless; it:test"

  it-nsq:
    if: ${{ github.event.repository.private == true }}
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
      - uses: coursier/cache-action@v6
      - name: Set up JDK 21
        uses: actions/setup-java@v4
        with:
          java-version: 21
          distribution: 'temurin'
      - name: Install sbt
        uses: sbt/setup-sbt@v1
      - name: Publish asset
        run: sbt "project nsqDistroless; publishLocal"
      - name: Run integration tests for enrich-nsq
        run: sbt "project nsqDistroless" IntegrationTest/test